service: vue-appsync-api

provider:
  name: aws
  runtime: nodejs18.x
  region: us-east-2
  stage: ${opt:stage, 'dev'}
  deploymentBucket:
    skipPolicySetup: true
    name: hazel-mapping-serverless-deployment-bucket

custom:
  # Shared Cognito User Pool ID (from dev stage)
  userPoolId: us-east-2_iAtP0Uzh5
  
  # Load database configurations from external file
  databaseConfig: ${file(../config/database-config.yml)}
  stageConfig: ${self:custom.databaseConfig.stages.${self:provider.stage}}
  appSync:
    name: vue-appsync-api-${self:provider.stage}
    authenticationType: AMAZON_COGNITO_USER_POOLS
    userPoolConfig:
      userPoolId: ${self:custom.userPoolId}
      defaultAction: ALLOW
    additionalAuthenticationProviders:
      - authenticationType: API_KEY
        apiKeyConfig:
          apiKeyExpirationDays: 30
    schema: schema.graphql
    logging:
      level: ALL
      roleArn: !GetAtt AppSyncLoggingRole.Arn
    dataSources:
      - type: RELATIONAL_DATABASE
        name: StageDataSource
        config:
          dbClusterIdentifier: ${self:custom.stageConfig.clusterIdentifier}
          databaseName: ${self:custom.stageConfig.databaseName}
          awsSecretStoreArn: ${self:custom.stageConfig.secretArn}
          serviceRoleArn: !GetAtt RDSServiceRole.Arn
    mappingTemplates:
      - dataSource: StageDataSource
        type: Mutation
        field: createCONFIG_PARAM
        request: Mutation.createCONFIG_PARAM.request.vtl
        response: Mutation.createCONFIG_PARAM.response.vtl
      - dataSource: StageDataSource
        type: Mutation
        field: createFILTER_CRITERIA
        request: Mutation.createFILTER_CRITERIA.request.vtl
        response: Mutation.createFILTER_CRITERIA.response.vtl
      - dataSource: StageDataSource
        type: Mutation
        field: createORIGIN_PRODUCT
        request: Mutation.createORIGIN_PRODUCT.request.vtl
        response: Mutation.createORIGIN_PRODUCT.response.vtl
      - dataSource: StageDataSource
        type: Mutation
        field: createREDIRECT_URL
        request: Mutation.createREDIRECT_URL.request.vtl
        response: Mutation.createREDIRECT_URL.response.vtl
      - dataSource: StageDataSource
        type: Mutation
        field: createSERVICE
        request: Mutation.createSERVICE.request.vtl
        response: Mutation.createSERVICE.response.vtl
      - dataSource: StageDataSource
        type: Mutation
        field: createSERVICE_DOMAIN
        request: Mutation.createSERVICE_DOMAIN.request.vtl
        response: Mutation.createSERVICE_DOMAIN.response.vtl
      - dataSource: StageDataSource
        type: Mutation
        field: createSERVICE_EXPR_MAPPING
        request: Mutation.createSERVICE_EXPR_MAPPING.request.vtl
        response: Mutation.createSERVICE_EXPR_MAPPING.response.vtl
      - dataSource: StageDataSource
        type: Mutation
        field: createSERVICE_PARAM
        request: Mutation.createSERVICE_PARAM.request.vtl
        response: Mutation.createSERVICE_PARAM.response.vtl
      - dataSource: StageDataSource
        type: Mutation
        field: createSERVICE_PARAM_MAPPING
        request: Mutation.createSERVICE_PARAM_MAPPING.request.vtl
        response: Mutation.createSERVICE_PARAM_MAPPING.response.vtl
      - dataSource: StageDataSource
        type: Mutation
        field: createSERVICE_PROVIDER
        request: Mutation.createSERVICE_PROVIDER.request.vtl
        response: Mutation.createSERVICE_PROVIDER.response.vtl
      - dataSource: StageDataSource
        type: Mutation
        field: createSORT_CRITERIA
        request: Mutation.createSORT_CRITERIA.request.vtl
        response: Mutation.createSORT_CRITERIA.response.vtl
      - dataSource: StageDataSource
        type: Mutation
        field: createSTEP_SERVICE_MAPPING
        request: Mutation.createSTEP_SERVICE_MAPPING.request.vtl
        response: Mutation.createSTEP_SERVICE_MAPPING.response.vtl
      - dataSource: StageDataSource
        type: Mutation
        field: createSTEP_TYPE
        request: Mutation.createSTEP_TYPE.request.vtl
        response: Mutation.createSTEP_TYPE.response.vtl
      - dataSource: StageDataSource
        type: Mutation
        field: createSTEP_TYPE_PARAM_MAP
        request: Mutation.createSTEP_TYPE_PARAM_MAP.request.vtl
        response: Mutation.createSTEP_TYPE_PARAM_MAP.response.vtl
      - dataSource: StageDataSource
        type: Mutation
        field: deleteCONFIG_PARAM
        request: Mutation.deleteCONFIG_PARAM.request.vtl
        response: Mutation.deleteCONFIG_PARAM.response.vtl
      - dataSource: StageDataSource
        type: Mutation
        field: deleteFILTER_CRITERIA
        request: Mutation.deleteFILTER_CRITERIA.request.vtl
        response: Mutation.deleteFILTER_CRITERIA.response.vtl
      - dataSource: StageDataSource
        type: Mutation
        field: deleteORIGIN_PRODUCT
        request: Mutation.deleteORIGIN_PRODUCT.request.vtl
        response: Mutation.deleteORIGIN_PRODUCT.response.vtl
      - dataSource: StageDataSource
        type: Mutation
        field: deleteREDIRECT_URL
        request: Mutation.deleteREDIRECT_URL.request.vtl
        response: Mutation.deleteREDIRECT_URL.response.vtl
      - dataSource: StageDataSource
        type: Mutation
        field: deleteSERVICE
        request: Mutation.deleteSERVICE.request.vtl
        response: Mutation.deleteSERVICE.response.vtl
      - dataSource: StageDataSource
        type: Mutation
        field: deleteSERVICE_DOMAIN
        request: Mutation.deleteSERVICE_DOMAIN.request.vtl
        response: Mutation.deleteSERVICE_DOMAIN.response.vtl
      - dataSource: StageDataSource
        type: Mutation
        field: deleteSERVICE_EXPR_MAPPING
        request: Mutation.deleteSERVICE_EXPR_MAPPING.request.vtl
        response: Mutation.deleteSERVICE_EXPR_MAPPING.response.vtl
      - dataSource: StageDataSource
        type: Mutation
        field: deleteSERVICE_PARAM
        request: Mutation.deleteSERVICE_PARAM.request.vtl
        response: Mutation.deleteSERVICE_PARAM.response.vtl
      - dataSource: StageDataSource
        type: Mutation
        field: deleteSERVICE_PARAM_MAPPING
        request: Mutation.deleteSERVICE_PARAM_MAPPING.request.vtl
        response: Mutation.deleteSERVICE_PARAM_MAPPING.response.vtl
      - dataSource: StageDataSource
        type: Mutation
        field: deleteSERVICE_PROVIDER
        request: Mutation.deleteSERVICE_PROVIDER.request.vtl
        response: Mutation.deleteSERVICE_PROVIDER.response.vtl
      - dataSource: StageDataSource
        type: Mutation
        field: deleteSORT_CRITERIA
        request: Mutation.deleteSORT_CRITERIA.request.vtl
        response: Mutation.deleteSORT_CRITERIA.response.vtl
      - dataSource: StageDataSource
        type: Mutation
        field: deleteSTEP_SERVICE_MAPPING
        request: Mutation.deleteSTEP_SERVICE_MAPPING.request.vtl
        response: Mutation.deleteSTEP_SERVICE_MAPPING.response.vtl
      - dataSource: StageDataSource
        type: Mutation
        field: deleteSTEP_TYPE
        request: Mutation.deleteSTEP_TYPE.request.vtl
        response: Mutation.deleteSTEP_TYPE.response.vtl
      - dataSource: StageDataSource
        type: Mutation
        field: deleteSTEP_TYPE_PARAM_MAP
        request: Mutation.deleteSTEP_TYPE_PARAM_MAP.request.vtl
        response: Mutation.deleteSTEP_TYPE_PARAM_MAP.response.vtl
      - dataSource: StageDataSource
        type: Mutation
        field: updateCONFIG_PARAM
        request: Mutation.updateCONFIG_PARAM.request.vtl
        response: Mutation.updateCONFIG_PARAM.response.vtl
      - dataSource: StageDataSource
        type: Mutation
        field: updateFILTER_CRITERIA
        request: Mutation.updateFILTER_CRITERIA.request.vtl
        response: Mutation.updateFILTER_CRITERIA.response.vtl
      - dataSource: StageDataSource
        type: Mutation
        field: updateORIGIN_PRODUCT
        request: Mutation.updateORIGIN_PRODUCT.request.vtl
        response: Mutation.updateORIGIN_PRODUCT.response.vtl
      - dataSource: StageDataSource
        type: Mutation
        field: updateREDIRECT_URL
        request: Mutation.updateREDIRECT_URL.request.vtl
        response: Mutation.updateREDIRECT_URL.response.vtl
      - dataSource: StageDataSource
        type: Mutation
        field: updateSERVICE
        request: Mutation.updateSERVICE.request.vtl
        response: Mutation.updateSERVICE.response.vtl
      - dataSource: StageDataSource
        type: Mutation
        field: updateSERVICE_DOMAIN
        request: Mutation.updateSERVICE_DOMAIN.request.vtl
        response: Mutation.updateSERVICE_DOMAIN.response.vtl
      - dataSource: StageDataSource
        type: Mutation
        field: updateSERVICE_EXPR_MAPPING
        request: Mutation.updateSERVICE_EXPR_MAPPING.request.vtl
        response: Mutation.updateSERVICE_EXPR_MAPPING.response.vtl
      - dataSource: StageDataSource
        type: Mutation
        field: updateSERVICE_PARAM
        request: Mutation.updateSERVICE_PARAM.request.vtl
        response: Mutation.updateSERVICE_PARAM.response.vtl
      - dataSource: StageDataSource
        type: Mutation
        field: updateSERVICE_PARAM_MAPPING
        request: Mutation.updateSERVICE_PARAM_MAPPING.request.vtl
        response: Mutation.updateSERVICE_PARAM_MAPPING.response.vtl
      - dataSource: StageDataSource
        type: Mutation
        field: updateSERVICE_PROVIDER
        request: Mutation.updateSERVICE_PROVIDER.request.vtl
        response: Mutation.updateSERVICE_PROVIDER.response.vtl
      - dataSource: StageDataSource
        type: Mutation
        field: updateSORT_CRITERIA
        request: Mutation.updateSORT_CRITERIA.request.vtl
        response: Mutation.updateSORT_CRITERIA.response.vtl
      - dataSource: StageDataSource
        type: Mutation
        field: updateSTEP_SERVICE_MAPPING
        request: Mutation.updateSTEP_SERVICE_MAPPING.request.vtl
        response: Mutation.updateSTEP_SERVICE_MAPPING.response.vtl
      - dataSource: StageDataSource
        type: Mutation
        field: updateSTEP_TYPE
        request: Mutation.updateSTEP_TYPE.request.vtl
        response: Mutation.updateSTEP_TYPE.response.vtl
      - dataSource: StageDataSource
        type: Mutation
        field: updateSTEP_TYPE_PARAM_MAP
        request: Mutation.updateSTEP_TYPE_PARAM_MAP.request.vtl
        response: Mutation.updateSTEP_TYPE_PARAM_MAP.response.vtl
      - dataSource: StageDataSource
        type: Query
        field: listCONFIG_PARAMS
        request: Query.listCONFIG_PARAMS.request.vtl
        response: Query.listCONFIG_PARAMS.response.vtl
      - dataSource: StageDataSource
        type: Query
        field: listFILTER_CRITERIAS
        request: Query.listFILTER_CRITERIAS.request.vtl
        response: Query.listFILTER_CRITERIAS.response.vtl
      - dataSource: StageDataSource
        type: Query
        field: listLOAN_APPS
        request: Query.listLOAN_APPS.request.vtl
        response: Query.listLOAN_APPS.response.vtl
      - dataSource: StageDataSource
        type: Query
        field: listNEW_MEMBER_TOKENS
        request: Query.listNEW_MEMBER_TOKENS.request.vtl
        response: Query.listNEW_MEMBER_TOKENS.response.vtl
      - dataSource: StageDataSource
        type: Query
        field: listORIGIN_PRODUCTS
        request: Query.listORIGIN_PRODUCTS.request.vtl
        response: Query.listORIGIN_PRODUCTS.response.vtl
      - dataSource: StageDataSource
        type: Query
        field: listREDIRECT_URLS
        request: Query.listREDIRECT_URLS.request.vtl
        response: Query.listREDIRECT_URLS.response.vtl
      - dataSource: StageDataSource
        type: Query
        field: listSERVICES
        request: Query.listSERVICES.request.vtl
        response: Query.listSERVICES.response.vtl
      - dataSource: StageDataSource
        type: Query
        field: listSERVICE_DOMAINS
        request: Query.listSERVICE_DOMAINS.request.vtl
        response: Query.listSERVICE_DOMAINS.response.vtl
      - dataSource: StageDataSource
        type: Query
        field: listSERVICE_EXPR_MAPPINGS
        request: Query.listSERVICE_EXPR_MAPPINGS.request.vtl
        response: Query.listSERVICE_EXPR_MAPPINGS.response.vtl
      - dataSource: StageDataSource
        type: Query
        field: listSERVICE_PARAMS
        request: Query.listSERVICE_PARAMS.request.vtl
        response: Query.listSERVICE_PARAMS.response.vtl
      - dataSource: StageDataSource
        type: Query
        field: listSERVICE_PARAM_MAPPINGS
        request: Query.listSERVICE_PARAM_MAPPINGS.request.vtl
        response: Query.listSERVICE_PARAM_MAPPINGS.response.vtl
      - dataSource: StageDataSource
        type: Query
        field: listSERVICE_PROVIDERS
        request: Query.listSERVICE_PROVIDERS.request.vtl
        response: Query.listSERVICE_PROVIDERS.response.vtl
      - dataSource: StageDataSource
        type: Query
        field: listSORT_CRITERIAS
        request: Query.listSORT_CRITERIAS.request.vtl
        response: Query.listSORT_CRITERIAS.response.vtl
      - dataSource: StageDataSource
        type: Query
        field: listSTEP_SERVICE_MAPPINGS
        request: Query.listSTEP_SERVICE_MAPPINGS.request.vtl
        response: Query.listSTEP_SERVICE_MAPPINGS.response.vtl
      - dataSource: StageDataSource
        type: Query
        field: listSTEP_TYPES
        request: Query.listSTEP_TYPES.request.vtl
        response: Query.listSTEP_TYPES.response.vtl
      - dataSource: StageDataSource
        type: Query
        field: listSTEP_TYPE_PARAM_MAPS
        request: Query.listSTEP_TYPE_PARAM_MAPS.request.vtl
        response: Query.listSTEP_TYPE_PARAM_MAPS.response.vtl

plugins:
  - serverless-appsync-plugin

resources:
  Resources:

    
    EmailDomainValidationFunction:
      Type: AWS::Lambda::Function
      Properties:
        FunctionName: email-domain-validation-${self:provider.stage}
        Runtime: nodejs18.x
        Handler: index.handler
        Code:
          ZipFile: |
            exports.handler = async (event) => {
              const email = event.request.userAttributes.email;
              
              // Input validation
              if (!email || typeof email !== 'string') {
                throw new Error('Invalid email format');
              }
              
              var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
              if (!emailRegex.test(email)) {
                throw new Error('Invalid email format');
              }
              
              if (!email.endsWith('@velera.com')) {
                throw new Error('Only @velera.com email addresses are allowed');
              }
              
              console.log('Email validation passed for domain: ' + email.split('@')[1]);
              return event;
            };
        Role: !GetAtt LambdaExecutionRole.Arn
    
    PostConfirmationFunction:
      Type: AWS::Lambda::Function
      Properties:
        FunctionName: post-confirmation-${self:provider.stage}
        Runtime: nodejs18.x
        Handler: index.handler
        Code:
          ZipFile: |
            const { CognitoIdentityProviderClient, AdminAddUserToGroupCommand, ListUsersInGroupCommand } = require('@aws-sdk/client-cognito-identity-provider');
            const { SESClient, SendEmailCommand } = require('@aws-sdk/client-ses');
            
            const cognito = new CognitoIdentityProviderClient({ region: 'us-east-2' });
            const ses = new SESClient({ region: 'us-east-2' });
            
            exports.handler = async (event) => {
              const { userPoolId, userName } = event;
              const userAttributes = event.request.userAttributes;
              const region = process.env.AWS_REGION;
              
              // Input validation
              if (!userAttributes.email || !userAttributes.email.includes('@')) {
                console.error('Invalid email format');
                return event;
              }
              
              try {
                // Add user to ReadOnly group by default
                await cognito.send(new AdminAddUserToGroupCommand({
                  GroupName: 'readonly',
                  UserPoolId: userPoolId,
                  Username: userName
                }));
                
                console.log('User ' + userName + ' added to readonly group');
                
                // Send notification to admins about new user
                const adminUsers = await cognito.send(new ListUsersInGroupCommand({
                  GroupName: 'admin',
                  UserPoolId: userPoolId
                }));
                
                const adminEmails = adminUsers.Users.map(user => 
                  user.Attributes.find(attr => attr.Name === 'email')?.Value
                ).filter(email => email && email.includes('@'));
                
                console.log('Admin emails found:', JSON.stringify(adminEmails));
                
                if (adminEmails.length > 0) {
                  const emailParams = {
                    Source: 'eshubkagel@velera.com',
                    Destination: { ToAddresses: adminEmails },
                    Message: {
                      Subject: { Data: 'New User Registration: ' + userAttributes.email.split('@')[0] + '@*** (' + (userAttributes.name || 'Unknown') + ')' },
                      Body: {
                        Text: {
                          Data: 'New user has registered and been added to readonly group.\n\nUser Details:\n- Email: ' + userAttributes.email + '\n- Username: ' + userName + '\n- ' + (userAttributes.name || 'Requested Access: Unknown') + '\n\nTo add user to requested group:\nhttps://us-east-2.console.aws.amazon.com/cognito/v2/idp/user-pools/' + userPoolId + '/user-management/groups/details/' + (userAttributes.name ? userAttributes.name.replace('Requested: ', '').toLowerCase() : 'developer') + '/add-user?region=' + region
                        }
                      }
                    }
                  };
                  
                  console.log('Sending email TO:', JSON.stringify(adminEmails));
                  const result = await ses.send(new SendEmailCommand(emailParams));
                  console.log('SES Response:', JSON.stringify(result));
                  console.log('Notification sent to ' + adminEmails.length + ' admins');
                }
              } catch (error) {
                console.error('Error in post-confirmation:', error.message);
                console.error('Full error:', JSON.stringify(error));
              }
              
              return event;
            };
        Role: !GetAtt PostConfirmationLambdaRole.Arn
    
    PostConfirmationLambdaRole:
      Type: AWS::IAM::Role
      Properties:
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service: lambda.amazonaws.com
              Action: sts:AssumeRole
        ManagedPolicyArns:
          - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        Policies:
          - PolicyName: CognitoGroupManagement
            PolicyDocument:
              Version: '2012-10-17'
              Statement:
                - Effect: Allow
                  Action:
                    - cognito-idp:AdminAddUserToGroup
                    - cognito-idp:ListUsersInGroup
                  Resource: "arn:aws:cognito-idp:us-east-2:794611117044:userpool/us-east-2_iAtP0Uzh5"
                - Effect: Allow
                  Action:
                    - ses:SendEmail
                  Resource: 
                    - "arn:aws:ses:${self:provider.region}:*:identity/eshubkagel@velera.com"
    
    PostConfirmationLambdaPermission:
      Type: AWS::Lambda::Permission
      Properties:
        FunctionName: !Ref PostConfirmationFunction
        Action: lambda:InvokeFunction
        Principal: cognito-idp.amazonaws.com
        SourceArn: "arn:aws:cognito-idp:us-east-2:794611117044:userpool/us-east-2_iAtP0Uzh5"
    
    LambdaExecutionRole:
      Type: AWS::IAM::Role
      Properties:
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service: lambda.amazonaws.com
              Action: sts:AssumeRole
        ManagedPolicyArns:
          - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
    

    
    CognitoLambdaPermission:
      Type: AWS::Lambda::Permission
      Properties:
        FunctionName: !Ref EmailDomainValidationFunction
        Action: lambda:InvokeFunction
        Principal: cognito-idp.amazonaws.com
        SourceArn: "arn:aws:cognito-idp:us-east-2:794611117044:userpool/us-east-2_iAtP0Uzh5"
    

    

    

    
    AppSyncLoggingRole:
      Type: AWS::IAM::Role
      Properties:
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service: appsync.amazonaws.com
              Action: sts:AssumeRole
        Policies:
          - PolicyName: CloudWatchLogsAccess
            PolicyDocument:
              Version: '2012-10-17'
              Statement:
                - Effect: Allow
                  Action:
                    - logs:CreateLogGroup
                    - logs:CreateLogStream
                    - logs:PutLogEvents
                  Resource: '*'
    RDSServiceRole:
      Type: AWS::IAM::Role
      Properties:
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service: appsync.amazonaws.com
              Action: sts:AssumeRole
        Policies:
          - PolicyName: RDSDataAccess
            PolicyDocument:
              Version: '2012-10-17'
              Statement:
                - Effect: Allow
                  Action:
                    - rds-data:*
                  Resource: 
                    - "arn:aws:rds:${self:provider.region}:*:cluster:${self:custom.stageConfig.clusterIdentifier}"
                - Effect: Allow
                  Action:
                    - secretsmanager:GetSecretValue
                    - kms:Decrypt
                    - kms:DescribeKey
                  Resource: 
                    - "${self:custom.stageConfig.secretArn}"
                    - "arn:aws:kms:${self:provider.region}:*:key/*"
                - Effect: Allow
                  Action:
                    - logs:CreateLogGroup
                    - logs:CreateLogStream
                    - logs:PutLogEvents
                  Resource: 
                    - "arn:aws:logs:${self:provider.region}:*:log-group:/aws/appsync/*"

